# 如何设计一个秒杀系统

秒杀系统本质上就是一个满足大并发、高性能和高可用的分布式系统。

## 架构原则：4要1不要

### 1. 数据要尽量少

减少用户请求来的数据量，减少返回给用户的数据量。
数据在网络上传输都需要服务器处理，服务器在写网络时通常都要压缩和字符解码，都是非常消耗CPU的事情。

系统依赖的数据能少就少，包括系统完成某些业务逻辑需要读取和保存的数据，这些数据都要后端服务和数据库打交道。
调用其他服务会涉及到数据的序列化和反序列化，也是CPU杀手。

### 2. 请求数要尽量少

用户页面渲染时会有额外的请求， CSS/JavaScript、图片，以及 Ajax等，这些请求也要尽量少，每一个请求都会消耗资源，比如连接要建立三次握手，js串行加载，还有请求不同的域名会设计DNS解析，总之要减少请求数。

比如减少请求数最常见的就是合并CSS和JavaScript文件成为一个文件。服务端仍然是单个文件各自存放，只是服务端会有一个组件解析这个 URL，然后动态把这些文件合并起来一起返回。

### 3. 路径要尽量短

用户发出请求到返回数据的整个链路经过的节点数要少。每一次连接都会增加新的不确定性，一次请求经过 5 个节点，每个节点的可用性是 99.9% 的话，那么整个请求的可用性是：99.9% 的 5 次方，约等于 99.5%。

缩短请求路径不仅可以增加可用性，同样可以有效提升性能（减少中间节点可以减少数据的序列化与反序列化），并减少延时（可以减少网络传输耗时）

缩短访问路径有一种办法，就是多个相互强依赖的应用合并部署在一起，把远程过程调用（RPC）变成 JVM 内部之间的方法调用。

### 4. 依赖要尽量少

所谓依赖，指的是要完成一次用户请求必须依赖的系统或者服务，这里的依赖指的是强依赖。

例如秒杀页面必须强依赖商品信息、用户信息，还有其他如优惠券、成交列表等这些对秒杀不是非要不可的信息（弱依赖），这些弱依赖在紧急情况下就可以去掉。

要减少依赖，我们可以给系统进行分级，比如 0 级系统、1 级系统、2 级系统、3 级系统，0 级系统如果是最重要的系统，那么 0 级系统强依赖的系统也同样是最重要的系统，以此类推。

注意，0 级系统要尽量减少对 1 级系统的强依赖，防止重要的系统被不重要的系统拖垮。例如支付系统是 0 级系统，而优惠券是 1 级系统的话，在极端情况下可以把优惠券给降级，防止支付系统被优惠券这个 1 级系统给拖垮

### 5. 不要又单点

系统中的单点可以说是系统架构上的一个大忌，因为单点意味着没有备份，风险不可控，我们设计分布式系统最重要的原则就是“消除单点”。

关键点是避免将服务的状态和机器绑定，即把服务无状态化，这样服务就可以在机器中随意移动。

## 不同场景下的不同架构案例

简单的秒杀系统只需要把售票购买页面增加一个“定时上架”的功能，仅在秒杀开始时才让用户看到购买按钮。
